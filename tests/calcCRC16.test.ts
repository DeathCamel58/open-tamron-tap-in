import { expect, test, describe } from 'vitest'
import calcCRC16 from "../src/util/crc16";

describe('CRC', () => {
  describe('Sending Data', () => {
    test('CRC - Status Message', () => {
      const data = new Uint8Array([0x0F, 0x01, 0x01, 0x00, 0x01, 0x00, 0xFA]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0x7d, 0x1c]);
      expect(crc).toEqual(expected);
    })

    test('CRC - IS_LENS_ATTACHED Message', () => {
      const data = new Uint8Array([0x0F, 0x02, 0x01, 0x00, 0x01, 0x00, 0xF7]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0x30, 0x03]);
      expect(crc).toEqual(expected);
    })

    test('CRC - WAITING_FOR_LENS Message', () => {
      const data = new Uint8Array([0x0F, 0x03, 0x01, 0x00, 0x02, 0x00, 0xF8, 0x00]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0xE0, 0x33]);
      expect(crc).toEqual(expected);
    })

    test('CRC - POWER_ON Message', () => {
      const data = new Uint8Array([0x0F, 0x04, 0x00, 0x00, 0x01, 0x00, 0xFA]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0x2D, 0xF5]);
      expect(crc).toEqual(expected);
    })

    test('CRC - OBATAIN_LENS_INFORMATION Message', () => {
      const data = new Uint8Array([0x0F, 0x05, 0x00, 0x00, 0x01, 0x00, 0xFC]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0x4B, 0xD0]);
      expect(crc).toEqual(expected);
    })

    test('CRC - OBTAIN_LENS_SETTING 1 Message', () => {
      const data = new Uint8Array([0x0F, 0x06, 0x00, 0x00, 0x01, 0x00, 0xFA]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0x6D, 0x7E]);
      expect(crc).toEqual(expected);
    })

    test('CRC - OBTAIN_LENS_SETTING 2 Message', () => {
      const data = new Uint8Array([0x0F, 0x07, 0x01, 0x00, 0x01, 0x00, 0xF9]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0xFF, 0xA1]);
      expect(crc).toEqual(expected);
    })
  })

  describe('Receiving Data', () => {
    test('CRC - Status Response', () => {
      const data = new Uint8Array([
        0x0F, 0x01, 0x01, 0x00, 0x56, 0x00, 0xFA, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x01,
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00
      ]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0xF3, 0x58]);
      expect(crc).toEqual(expected);
    })

    test('CRC - IS_LENS_ATTACHED Response', () => {
      const data = new Uint8Array([0x0F, 0x02, 0x01, 0x00, 0x02, 0x00, 0xF7, 0x01]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0x9E, 0x8B]);
      expect(crc).toEqual(expected);
    })

    test('CRC - WAITING_FOR_LENS Response', () => {
      const data = new Uint8Array([0x0F, 0x03, 0x01, 0x00, 0x02, 0x00, 0xF8, 0x01]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0xC1, 0x23]);
      expect(crc).toEqual(expected);
    })

    test('CRC - POWER_ON Response', () => {
      const data = new Uint8Array([
        0x0F, 0x04, 0x00, 0x00, 0x56, 0x00, 0xFA, 0x00,
        0x00, 0x00, 0x46, 0x30, 0x31, 0x33, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x30, 0x30, 0x30, 0x30, 0x31, 0x39,
        0x30, 0x33, 0x30, 0x30, 0x30, 0x30, 0x37, 0x33,
        0x31, 0x35, 0x03, 0x01, 0x02, 0x00, 0x01, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x0B, 0x00, 0x01, 0x03, 0x00, 0x35,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0xEC,
        0x00, 0x00, 0x00, 0x00, 0x2D, 0x00, 0x2D, 0x00,
        0x2D, 0x00, 0x2D, 0x00, 0x2D, 0x00, 0x2D, 0x00,
        0x2D, 0x00, 0x2D, 0x00
      ]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0x14, 0xB7]);
      expect(crc).toEqual(expected);
    })

    test('CRC - OBTAIN_LENS_INFORMATION Response', () => {
      const data = new Uint8Array([
        0x0F, 0x05, 0x00, 0x00, 0x24, 0x00, 0xFC, 0x02,
        0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
        0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00
      ]);
      const crc = calcCRC16(data);
      const expected = new Uint8Array([0x4A, 0x50]);
      expect(crc).toEqual(expected);
    })
  })
})
